# 高德 MCP + 浏览器 MCP：LangChain 复用别人的 MCP Server - 总结

对应代码：在 `chapter/4/tool-test` 的 LangChain MCP 调用基础上，增加多 MCP Server 配置（如 `mcp-test.mjs`）。环境变量：根目录 `.env` 中除 `OPENAI_*` 外，按需配置 `AMAP_MAPS_API_KEY`（高德）、`ALLOWED_PATHS`（FileSystem MCP 可访问目录，逗号分隔）。

---

## 一、为什么复用别人的 MCP

- 上节手写 MCP Server，本质仍是 Tool，只是通过 stdio/http 跨进程暴露。
- 有了统一协议后，任何人开发的 MCP Server 都可以被直接复用，无需自己实现高德 API、浏览器控制、文件系统等逻辑。
- 本节示例：**高德 MCP**（位置、路线）、**FileSystem MCP**（读写文件、建目录）、**Chrome DevTools MCP**（打开页面、点击、截图等浏览器自动化）。

## 二、高德 MCP

- **获取 Key**： [高德开放平台](https://developer.amap.com/) 创建应用，添加 Key，类型选「Web 服务」即可。
- **接入方式**：
  - **HTTP**：`"amap-maps-streamableHTTP": { "url": "https://mcp.amap.com/mcp?key=" + process.env.AMAP_MAPS_API_KEY }`，适合 Cursor 或 LangChain 远程连接。
  - **stdio**：`"amap-maps": { "command": "npx", "args": ["-y", "@amap/amap-maps-mcp-server"], "env": { "AMAP_MAPS_API_KEY": "你的 key" } }`，本地进程方式。
- 在 Cursor 中配置任一种方式后，即可在对话里使用该 Server 暴露的 tools（如地点搜索、路线规划）；在 LangChain 中通过 **MultiServerMCPClient** 把高德 MCP 与其他 MCP 一起配置，见下节。

## 三、MultiServerMCPClient 与 Agent 循环

- 使用 **@langchain/mcp-adapters** 的 **MultiServerMCPClient**，在 `mcpServers` 中同时配置多个 Server，例如本地自写 Server（command + args）、高德（url）、FileSystem（command + args + env）等。
- **getTools()** 拉取所有 Server 的 Tool，**model.bindTools(tools)** 后与第 2、3、4 章一致：invoke → 若有 tool_calls 则执行工具 → 将结果封装为 **ToolMessage**（带 tool_call_id）追加到 messages → 再 invoke，直到无 tool_calls。
- 用完后调用 **mcpClient.close()**，避免子进程或连接未释放。

## 四、FileSystem MCP

- 官方维护：`@modelcontextprotocol/server-filesystem`，通过 **stdio** 接入，例如 `command: "npx", args: ["-y", "@modelcontextprotocol/server-filesystem", ...(process.env.ALLOWED_PATHS.split(','))]`，用于限制可访问目录。
- 提供读写文件、创建目录、移动文件等 Tool；在 Cursor 中配置后即可在对话里使用，在 LangChain 中与其他 MCP 一起放入 MultiServerMCPClient 即可。
- **返回格式**：该 MCP 的 Tool 返回的是**对象**（如带 `text` 字段），而非纯字符串。在构造 ToolMessage 时需统一成字符串，例如：
  - 若 `toolResult` 为 string 则直接用；
  - 若为对象且存在 `toolResult.text`，则用 `toolResult.text` 作为 ToolMessage 的 content。
- 这样大模型无需自己实现文件读写 Tool，直接复用即可。

## 五、Chrome DevTools MCP

- 用于**浏览器自动化**：打开页面、点击元素、截图等，基于 CDP 协议。
- Cursor 配置示例：`"chrome-devtools": { "command": "npx", "args": ["-y", "chrome-devtools-mcp@latest"] }`，配置后可在对话中控制浏览器。
- 在 LangChain 中同样将该 Server 加入 MultiServerMCPClient 的 `mcpServers`，即可在 Agent 循环中由模型自动选择并调用（如「打开某 URL」「截图」）。
- 典型用法：结合高德 MCP 查地点、路线，再让模型调用 Chrome DevTools MCP 打开浏览器展示结果或图片。

## 六、综合示例与注意点

- 示例流程：用户问「北京南站附近的酒店及路线，并保存到某路径的 md 文件」→ 模型依次调用高德 MCP（查酒店、路线）、FileSystem MCP（写文件）；或再增加「打开浏览器展示酒店图片」→ 模型再调用 Chrome DevTools MCP。
- **环境变量**：高德需 `AMAP_MAPS_API_KEY`；FileSystem 需 `ALLOWED_PATHS`（逗号分隔的可访问路径）；其余与第 4 章一致（OPENAI_*、dotenv 等）。
- 自己实现的 Tool 若希望被别人复用，可封装成 MCP Server 并发布为 npm 包，支持 stdio（或 http），即可在 Cursor / LangChain 中被直接使用，也可作为简历中的实践项。

## 七、总结

- **复用他人 MCP**：高德、FileSystem、Chrome DevTools 等 MCP Server 可直接接入，无需关心内部 API 或 CDP 细节；大模型通过 tool 描述与参数自动调用。
- **接入方式**：stdio（command + args，本地进程）与 http（url，远程）两种；同一 **MultiServerMCPClient** 可混用多种 MCP。
- **实现要点**：MultiServerMCPClient 配置多 Server → getTools() → bindTools → 原有 Tool 循环 + ToolMessage；注意部分 MCP 返回对象需取 `text` 再写入 ToolMessage；用完后 close。
- **效果**：配好 MCP 后，大模型即可完成地理位置查询、路线规划、文件写入、浏览器打开与截图等，全程复用现成能力，无需手写这些 Tool。
